<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Investment Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
  function toggleMaturityField() {
    const accountType = document.querySelector('[name="account_type"]');
    const maturityGroup = document.getElementById("maturity-group");
    const maturityInput = document.querySelector('[name="maturity_date"]');
    const savingInvested = document.querySelector('[name="saving_invested"]');
    const rdIncrementGroup = document.getElementById("rd-increment-group");

    if (accountType.value.toLowerCase() === "savings") {
      maturityGroup.style.display = "none";
      maturityInput.required = false;
      savingInvested.value = "Saving";
      rdIncrementGroup.style.display = "none";
    } else {
      maturityGroup.style.display = "block";
      maturityInput.required = true;
      savingInvested.value = "Invested";
      if (accountType.value === "RD") {
        rdIncrementGroup.style.display = "block";
      } else {
        rdIncrementGroup.style.display = "none";
      }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    toggleMaturityField();
    document.querySelector('[name="account_type"]').addEventListener("change", toggleMaturityField);
  });
</script>


</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="mb-4">Investment Tracker</h2>
<div class="mb-3">
  <a href="/dashboard" class="btn btn-info">üìä View Dashboard</a>
</div>
<a href="/manage_options" class="btn btn-outline-primary">‚öôÔ∏è Manage Bank & Account Types</a>


  {% if next_maturity %}
  <div class="alert alert-info">
    <strong>Upcoming Maturities:</strong>
    <ul class="mb-0">
      {% for m in next_maturity %}
        <li>{{ m[3] }} ‚Äî <strong>{{ m[0] }}</strong> ({{ m[1] }}, {{ m[2] }})</li>
      {% endfor %}
    </ul>
  </div>
  {% else %}
  <div class="alert alert-warning">No upcoming maturity dates found.</div>
  {% endif %}

  <!-- Add Investment Form -->
  <form method="POST" class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Reference Name</label>
      <input name="reference_name" class="form-control" placeholder="e.g. FD-Axis-2025-2028">
    </div>
    <div class="col-md-6">
      <label class="form-label">Bank</label>
      <select name="bank" class="form-select" required>
  {% for b in banks %}
    <option>{{ b }}</option>
  {% endfor %}
</select>

    </div>
    <div class="col-md-4">
    <label class="form-label">Account Type</label>
    <select name="account_type" class="form-select" onchange="toggleMaturityField()">
  {% for t in account_types %}
    <option>{{ t }}</option>
  {% endfor %}
</select>

  </div>

  <div class="col-md-4" id="rd-increment-group" style="display: none;">
    <label class="form-label">Monthly Increment (e.g. 1000)</label>
    <input name="rd_increment" class="form-control" type="number" step="0.01">
  </div>
    
    <div class="col-md-4">
      <label class="form-label">Saving/Invested</label>
      <select name="saving_invested" class="form-select">
        <option>Saving</option><option>Invested</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        <option>Open</option><option>Closed</option>
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Start Year</label>
      <select name="year" class="form-select">
        {% for y in range(2025, 2035) %}
          <option>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6" id="maturity-group">
      <label class="form-label">Maturity Date</label>
      <input name="maturity_date" class="form-control" type="date">
    </div>

    {% for month in ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'] %}
    <div class="col-md-2">
      <label class="form-label">{{ month.capitalize() }}</label>
      <input name="{{ month }}" class="form-control" type="number" step="0.01">
    </div>
    {% endfor %}

    <div class="col-12">
      <label class="form-label">Notepad</label>
      <textarea name="notepad" class="form-control"></textarea>
    </div>

    <div class="col-12">
      <button class="btn btn-primary">Add Investment</button>
    </div>
  </form>

  <hr>
<form method="get" class="row g-3 mb-4">
  <div class="col-md-2">
    <label class="form-label">Bank</label>
    <select name="bank" class="form-select">
  <option value="">All</option>
  {% for b in banks %}
    <option value="{{ b }}" {% if filters.bank == b %}selected{% endif %}>{{ b }}</option>
  {% endfor %}
</select>

  </div>
  <div class="col-md-2">
    <label class="form-label">Account Type</label>
    <select name="account_type" class="form-select">
  <option value="">All</option>
  {% for t in account_types %}
    <option value="{{ t }}" {% if filters.account_type == t %}selected{% endif %}>{{ t }}</option>
  {% endfor %}
</select>

  </div>
 


  <div class="col-md-2">
    <label class="form-label">Saving/Invested</label>
    <select name="saving_invested" class="form-select">
      <option value="">All</option>
      <option value="Saving" {% if filters.saving_invested == 'Saving' %}selected{% endif %}>Saving</option>
      <option value="Invested" {% if filters.saving_invested == 'Invested' %}selected{% endif %}>Invested</option>
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Status</label>
    <select name="status" class="form-select">
      <option value="">All</option>
      <option value="Open" {% if filters.status == 'Open' %}selected{% endif %}>Open</option>
      <option value="Closed" {% if filters.status == 'Closed' %}selected{% endif %}>Closed</option>
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Maturity Date (From)</label>
    <input type="date" name="start_date" class="form-control" value="{{ filters.start_date }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">Maturity Date (To)</label>
    <input type="date" name="end_date" class="form-control" value="{{ filters.end_date }}">
  </div>
  <div class="col-md-12">
    <button class="btn btn-primary">Apply Filters</button>
    <a href="/" class="btn btn-secondary">Reset</a>
  </div>
  <label>
  <input type="checkbox" name="unique_only" value="1" {% if filters.unique_only %}checked{% endif %}>
  Show only unique reference names
</label>

</form>

  {% if records %}
  <!-- Data Table -->
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>ID</th><th>Ref Name</th><th>Bank</th><th>Type</th><th>Saving/Invested</th>
        <th>Status</th><th>Year</th><th>Maturity</th>
        {% for month in ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] %}
          <th>{{ month }}</th>
        {% endfor %}
        <th>Total</th><th>Note</th><th>Edit</th><th>Delete</th><th>Delete All</th>
      </tr>
    </thead>
    <tbody>
      {% set seen_refs = [] %}
      {% for r in records %}
      <tr>
        <td>{{ r[0] }}</td><td>{{ r[2] }}</td><td>{{ r[3] }}</td><td>{{ r[4] }}</td><td>{{ r[5] }}</td>
        <td>{{ r[6] }}</td><td>{{ r[7] }}</td><td>{{ r[8] }}</td>
        {% set total = 0 %}
        {% for i in range(9, 21) %}
          <td>{{ r[i] }}</td>
          {% set total = total + (r[i]|float) %}
        {% endfor %}
        <td>{{ total }}</td>
        <td>{{ r[-1] }}</td>
        <td>
          {% if r[4] in ['FD', 'NSC', 'RD'] %}
            <button class="btn btn-sm btn-secondary" disabled>Edit</button>
          {% else %}
            <a href="/update/{{ r[1] }}" class="btn btn-sm btn-warning">Edit</a>
          {% endif %}
        </td>
        <td><a href="/delete/{{ r[0] }}" class="btn btn-sm btn-danger">Delete</a></td>
        <td>
          {% if r[2] not in seen_refs %}
            <a href="/delete_by_ref/{{ r[2] }}" class="btn btn-sm btn-outline-danger"
               onclick="return confirm('Delete ALL records for {{ r[2] }}?')">Delete All</a>
            {% set _ = seen_refs.append(r[2]) %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      <tr class="table-secondary fw-bold">
        <td colspan="8">Monthly Totals</td>
        {% for total in monthly_totals %}
          <td>{{ total }}</td>
        {% endfor %}
        <td></td><td></td><td></td><td></td>
      </tr>
    </tbody>
  </table>

  <a href="/export/csv" class="btn btn-outline-secondary">Export CSV</a>
  <a href="/export/excel" class="btn btn-outline-success">Export Excel</a>
{% else %}
  <p class="alert alert-warning">No data yet. Apply filters to see results.</p>
{% endif %}

</div>
</body>
</html>
